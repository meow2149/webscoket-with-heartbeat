var WebSocketWithHeartbeat=function(){"use strict";const e={heartbeatInterval:3e4,reconnectDelay:5e3,timeout:5e3,debug:!1};return class{options;url;webSocket=null;isManualClosed=!1;heartbeat={ping:"ping",pong:"pong"};heartbeatTimer;reconnectTimer;preCloseTimer;constructor(t,o){this.options={...e,...o},this.url=t.replace(/^http/,"ws"),this.connect()}connect(){this.webSocket=new WebSocket(this.url),this.webSocket.onopen=this.onOpen.bind(this),this.webSocket.onmessage=this.onMessage.bind(this),this.webSocket.onclose=this.onClose.bind(this),this.webSocket.onerror=this.onError.bind(this)}onopen=()=>{};onmessage=()=>{};onclose=()=>{};onerror=()=>{};send(e){this.webSocket?.readyState===WebSocket.OPEN&&(this.webSocket.send(e),this.debugLog("Sent:",e))}close(){this.debugLog("Disconnect manually."),this.isManualClosed=!0,this.webSocket?.close(),this.stopHeartbeat()}onOpen(e){this.debugLog("Connected."),this.onopen(e),this.startHeartbeat()}onMessage(e){this.debugLog("Received:",e.data);JSON.parse(e.data).type===this.heartbeat.pong?(this.debugLog("Closing cancelled."),clearTimeout(this.preCloseTimer),this.preCloseTimer=void 0):this.onmessage(e)}onClose(e){this.debugLog("Disconnected."),this.onclose(e),this.isManualClosed||(this.stopHeartbeat(),this.reconnect())}onError(e){this.debugLog("Error occurred:",e),this.onerror(e)}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.webSocket?.readyState===WebSocket.OPEN&&(this.webSocket.send(JSON.stringify({type:this.heartbeat.ping})),this.preClose())}),this.options.heartbeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}reconnect(){this.reconnectTimer=setTimeout((()=>{this.debugLog("Reconnecting..."),this.connect(),this.stopReconnect()}),this.options.reconnectDelay)}stopReconnect(){clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0}preClose(){this.debugLog(`Closing in ${this.options.timeout}ms...`),this.preCloseTimer=setTimeout((()=>{this.webSocket?.close(),clearTimeout(this.preCloseTimer),this.preCloseTimer=void 0}),this.options.timeout)}debugLog(...e){this.options.debug&&console.log("%c WebSocketWithHeartbeat","background:#222;color:#ffd700;padding:4px;border-radius:5px;",...e)}}}();
