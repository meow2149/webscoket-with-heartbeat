var WebSocketWithHeartbeat=function(){"use strict";const t={heartbeatInterval:3e4,reconnectInterval:5e3,maxReconnectAttempts:0,maxReconnectInterval:5e3,debug:!1};return class{heartbeatInterval;reconnectInterval;maxReconnectAttempts;maxReconnectInterval;debug;url;heartbeatTimer=null;reconnectTimer=null;reconnectAttempts=0;ws=null;onopen=()=>{};onmessage=()=>{};onclose=()=>{};onerror=()=>{};constructor(e,n){const s={...t,...n};this.heartbeatInterval=s.heartbeatInterval,this.reconnectInterval=s.reconnectInterval,this.maxReconnectAttempts=s.maxReconnectAttempts,this.maxReconnectInterval=s.maxReconnectInterval,this.debug=s.debug,this.url=e.replace(/^http/,"ws"),this.connect()}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=()=>this.onOpen(),this.ws.onmessage=t=>this.onMessage(t),this.ws.onclose=()=>this.onClose(),this.ws.onerror=t=>this.onError(t)}onOpen(){this.onopen(),this.log("WebSocket连接已建立"),this.reconnectAttempts=0,this.startHeartbeat()}onMessage(t){try{const e=JSON.parse(t.data);this.log("收到服务器消息:",e),"pong"===e.type?this.resetHeartbeat():this.onmessage(t)}catch(t){this.log(t)}}onClose(){this.onclose(),this.log("WebSocket连接已关闭，尝试重连..."),this.cleanup(),this.reconnect()}onError(t){this.onerror(t),this.log("WebSocket错误:",t)}send(t){this.ws?.readyState===WebSocket.OPEN?(this.ws.send(t),this.log("发送消息:",t)):this.log("WebSocket 连接未打开，无法发送消息")}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval((()=>{if(this.ws?.readyState===WebSocket.OPEN){const t={type:"ping"};this.ws.send(JSON.stringify(t)),this.log("发送心跳消息:",t)}}),this.heartbeatInterval)}resetHeartbeat(){this.stopHeartbeat(),this.startHeartbeat()}stopHeartbeat(){null!==this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}cleanup(){this.stopHeartbeat(),null!==this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}log(...t){this.debug&&console.log(...t)}reconnect(){0===this.maxReconnectAttempts||this.reconnectAttempts<this.maxReconnectAttempts?null===this.reconnectTimer&&(this.reconnectTimer=setTimeout((()=>{this.reconnectAttempts++,this.connect(),this.reconnectTimer=null}),this.reconnectInterval)):this.log("达到最大重连次数，停止重连")}}}();
